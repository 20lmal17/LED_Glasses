#include <stdint.h>
#include <string.h>

#include <libopencm3/stm32/gpio.h>
#include <libopencm3/stm32/rcc.h>
#include <libopencm3/stm32/spi.h>

#include "led.h"

#define SPI_BYTE_PER_LED_BYTE (4UL)

#define LED_00          (0x88)
#define LED_01          (0x8C)
#define LED_10          (0xC8)
#define LED_11          (0xCC)
#define LED_BYTES       (3UL * SPI_BYTE_PER_LED_BYTE) // 24b colour
#define LED_RESET_SIZE  (100)//(34) // 80us / 2.4us
#define LED_BUFFER_SIZE (LED_BYTES * LED_COUNT)

static const uint32_t LED_ADDRESSES[LED_ROWS][LED_COLS] = {
    { 37, 36, 35, 34,  33,   32, 31, 30, 29,  28},
    { 38, 39, 40, 41,  42,   23, 24, 25, 26,  27},
    { 47, 46, 45, 44,  43,   22, 21, 20, 19,  18},
    { 48, 49, 50, 51,  52,   13, 14, 15, 16,  17},
    { 57, 56, 55, 54,  53,   12, 11, 10,  9,   8},
    { 58, 59, 60, 61,  62,    3,  4,  5,  6,   7},
    {999, 65, 64, 63, 999,  999,  2,  1,  0, 999}
};
static const uint8_t COLOUR_MAP[SPI_BYTE_PER_LED_BYTE * 0x100] = {
    0x88, 0x88, 0x88, 0x88,
    0x88, 0x88, 0x88, 0x8c,
    0x88, 0x88, 0x88, 0xc8,
    0x88, 0x88, 0x88, 0xcc,
    0x88, 0x88, 0x8c, 0x88,
    0x88, 0x88, 0x8c, 0x8c,
    0x88, 0x88, 0x8c, 0xc8,
    0x88, 0x88, 0x8c, 0xcc,
    0x88, 0x88, 0xc8, 0x88,
    0x88, 0x88, 0xc8, 0x8c,
    0x88, 0x88, 0xc8, 0xc8,
    0x88, 0x88, 0xc8, 0xcc,
    0x88, 0x88, 0xcc, 0x88,
    0x88, 0x88, 0xcc, 0x8c,
    0x88, 0x88, 0xcc, 0xc8,
    0x88, 0x88, 0xcc, 0xcc,
    0x88, 0x8c, 0x88, 0x88,
    0x88, 0x8c, 0x88, 0x8c,
    0x88, 0x8c, 0x88, 0xc8,
    0x88, 0x8c, 0x88, 0xcc,
    0x88, 0x8c, 0x8c, 0x88,
    0x88, 0x8c, 0x8c, 0x8c,
    0x88, 0x8c, 0x8c, 0xc8,
    0x88, 0x8c, 0x8c, 0xcc,
    0x88, 0x8c, 0xc8, 0x88,
    0x88, 0x8c, 0xc8, 0x8c,
    0x88, 0x8c, 0xc8, 0xc8,
    0x88, 0x8c, 0xc8, 0xcc,
    0x88, 0x8c, 0xcc, 0x88,
    0x88, 0x8c, 0xcc, 0x8c,
    0x88, 0x8c, 0xcc, 0xc8,
    0x88, 0x8c, 0xcc, 0xcc,
    0x88, 0xc8, 0x88, 0x88,
    0x88, 0xc8, 0x88, 0x8c,
    0x88, 0xc8, 0x88, 0xc8,
    0x88, 0xc8, 0x88, 0xcc,
    0x88, 0xc8, 0x8c, 0x88,
    0x88, 0xc8, 0x8c, 0x8c,
    0x88, 0xc8, 0x8c, 0xc8,
    0x88, 0xc8, 0x8c, 0xcc,
    0x88, 0xc8, 0xc8, 0x88,
    0x88, 0xc8, 0xc8, 0x8c,
    0x88, 0xc8, 0xc8, 0xc8,
    0x88, 0xc8, 0xc8, 0xcc,
    0x88, 0xc8, 0xcc, 0x88,
    0x88, 0xc8, 0xcc, 0x8c,
    0x88, 0xc8, 0xcc, 0xc8,
    0x88, 0xc8, 0xcc, 0xcc,
    0x88, 0xcc, 0x88, 0x88,
    0x88, 0xcc, 0x88, 0x8c,
    0x88, 0xcc, 0x88, 0xc8,
    0x88, 0xcc, 0x88, 0xcc,
    0x88, 0xcc, 0x8c, 0x88,
    0x88, 0xcc, 0x8c, 0x8c,
    0x88, 0xcc, 0x8c, 0xc8,
    0x88, 0xcc, 0x8c, 0xcc,
    0x88, 0xcc, 0xc8, 0x88,
    0x88, 0xcc, 0xc8, 0x8c,
    0x88, 0xcc, 0xc8, 0xc8,
    0x88, 0xcc, 0xc8, 0xcc,
    0x88, 0xcc, 0xcc, 0x88,
    0x88, 0xcc, 0xcc, 0x8c,
    0x88, 0xcc, 0xcc, 0xc8,
    0x88, 0xcc, 0xcc, 0xcc,
    0x8c, 0x88, 0x88, 0x88,
    0x8c, 0x88, 0x88, 0x8c,
    0x8c, 0x88, 0x88, 0xc8,
    0x8c, 0x88, 0x88, 0xcc,
    0x8c, 0x88, 0x8c, 0x88,
    0x8c, 0x88, 0x8c, 0x8c,
    0x8c, 0x88, 0x8c, 0xc8,
    0x8c, 0x88, 0x8c, 0xcc,
    0x8c, 0x88, 0xc8, 0x88,
    0x8c, 0x88, 0xc8, 0x8c,
    0x8c, 0x88, 0xc8, 0xc8,
    0x8c, 0x88, 0xc8, 0xcc,
    0x8c, 0x88, 0xcc, 0x88,
    0x8c, 0x88, 0xcc, 0x8c,
    0x8c, 0x88, 0xcc, 0xc8,
    0x8c, 0x88, 0xcc, 0xcc,
    0x8c, 0x8c, 0x88, 0x88,
    0x8c, 0x8c, 0x88, 0x8c,
    0x8c, 0x8c, 0x88, 0xc8,
    0x8c, 0x8c, 0x88, 0xcc,
    0x8c, 0x8c, 0x8c, 0x88,
    0x8c, 0x8c, 0x8c, 0x8c,
    0x8c, 0x8c, 0x8c, 0xc8,
    0x8c, 0x8c, 0x8c, 0xcc,
    0x8c, 0x8c, 0xc8, 0x88,
    0x8c, 0x8c, 0xc8, 0x8c,
    0x8c, 0x8c, 0xc8, 0xc8,
    0x8c, 0x8c, 0xc8, 0xcc,
    0x8c, 0x8c, 0xcc, 0x88,
    0x8c, 0x8c, 0xcc, 0x8c,
    0x8c, 0x8c, 0xcc, 0xc8,
    0x8c, 0x8c, 0xcc, 0xcc,
    0x8c, 0xc8, 0x88, 0x88,
    0x8c, 0xc8, 0x88, 0x8c,
    0x8c, 0xc8, 0x88, 0xc8,
    0x8c, 0xc8, 0x88, 0xcc,
    0x8c, 0xc8, 0x8c, 0x88,
    0x8c, 0xc8, 0x8c, 0x8c,
    0x8c, 0xc8, 0x8c, 0xc8,
    0x8c, 0xc8, 0x8c, 0xcc,
    0x8c, 0xc8, 0xc8, 0x88,
    0x8c, 0xc8, 0xc8, 0x8c,
    0x8c, 0xc8, 0xc8, 0xc8,
    0x8c, 0xc8, 0xc8, 0xcc,
    0x8c, 0xc8, 0xcc, 0x88,
    0x8c, 0xc8, 0xcc, 0x8c,
    0x8c, 0xc8, 0xcc, 0xc8,
    0x8c, 0xc8, 0xcc, 0xcc,
    0x8c, 0xcc, 0x88, 0x88,
    0x8c, 0xcc, 0x88, 0x8c,
    0x8c, 0xcc, 0x88, 0xc8,
    0x8c, 0xcc, 0x88, 0xcc,
    0x8c, 0xcc, 0x8c, 0x88,
    0x8c, 0xcc, 0x8c, 0x8c,
    0x8c, 0xcc, 0x8c, 0xc8,
    0x8c, 0xcc, 0x8c, 0xcc,
    0x8c, 0xcc, 0xc8, 0x88,
    0x8c, 0xcc, 0xc8, 0x8c,
    0x8c, 0xcc, 0xc8, 0xc8,
    0x8c, 0xcc, 0xc8, 0xcc,
    0x8c, 0xcc, 0xcc, 0x88,
    0x8c, 0xcc, 0xcc, 0x8c,
    0x8c, 0xcc, 0xcc, 0xc8,
    0x8c, 0xcc, 0xcc, 0xcc,
    0xc8, 0x88, 0x88, 0x88,
    0xc8, 0x88, 0x88, 0x8c,
    0xc8, 0x88, 0x88, 0xc8,
    0xc8, 0x88, 0x88, 0xcc,
    0xc8, 0x88, 0x8c, 0x88,
    0xc8, 0x88, 0x8c, 0x8c,
    0xc8, 0x88, 0x8c, 0xc8,
    0xc8, 0x88, 0x8c, 0xcc,
    0xc8, 0x88, 0xc8, 0x88,
    0xc8, 0x88, 0xc8, 0x8c,
    0xc8, 0x88, 0xc8, 0xc8,
    0xc8, 0x88, 0xc8, 0xcc,
    0xc8, 0x88, 0xcc, 0x88,
    0xc8, 0x88, 0xcc, 0x8c,
    0xc8, 0x88, 0xcc, 0xc8,
    0xc8, 0x88, 0xcc, 0xcc,
    0xc8, 0x8c, 0x88, 0x88,
    0xc8, 0x8c, 0x88, 0x8c,
    0xc8, 0x8c, 0x88, 0xc8,
    0xc8, 0x8c, 0x88, 0xcc,
    0xc8, 0x8c, 0x8c, 0x88,
    0xc8, 0x8c, 0x8c, 0x8c,
    0xc8, 0x8c, 0x8c, 0xc8,
    0xc8, 0x8c, 0x8c, 0xcc,
    0xc8, 0x8c, 0xc8, 0x88,
    0xc8, 0x8c, 0xc8, 0x8c,
    0xc8, 0x8c, 0xc8, 0xc8,
    0xc8, 0x8c, 0xc8, 0xcc,
    0xc8, 0x8c, 0xcc, 0x88,
    0xc8, 0x8c, 0xcc, 0x8c,
    0xc8, 0x8c, 0xcc, 0xc8,
    0xc8, 0x8c, 0xcc, 0xcc,
    0xc8, 0xc8, 0x88, 0x88,
    0xc8, 0xc8, 0x88, 0x8c,
    0xc8, 0xc8, 0x88, 0xc8,
    0xc8, 0xc8, 0x88, 0xcc,
    0xc8, 0xc8, 0x8c, 0x88,
    0xc8, 0xc8, 0x8c, 0x8c,
    0xc8, 0xc8, 0x8c, 0xc8,
    0xc8, 0xc8, 0x8c, 0xcc,
    0xc8, 0xc8, 0xc8, 0x88,
    0xc8, 0xc8, 0xc8, 0x8c,
    0xc8, 0xc8, 0xc8, 0xc8,
    0xc8, 0xc8, 0xc8, 0xcc,
    0xc8, 0xc8, 0xcc, 0x88,
    0xc8, 0xc8, 0xcc, 0x8c,
    0xc8, 0xc8, 0xcc, 0xc8,
    0xc8, 0xc8, 0xcc, 0xcc,
    0xc8, 0xcc, 0x88, 0x88,
    0xc8, 0xcc, 0x88, 0x8c,
    0xc8, 0xcc, 0x88, 0xc8,
    0xc8, 0xcc, 0x88, 0xcc,
    0xc8, 0xcc, 0x8c, 0x88,
    0xc8, 0xcc, 0x8c, 0x8c,
    0xc8, 0xcc, 0x8c, 0xc8,
    0xc8, 0xcc, 0x8c, 0xcc,
    0xc8, 0xcc, 0xc8, 0x88,
    0xc8, 0xcc, 0xc8, 0x8c,
    0xc8, 0xcc, 0xc8, 0xc8,
    0xc8, 0xcc, 0xc8, 0xcc,
    0xc8, 0xcc, 0xcc, 0x88,
    0xc8, 0xcc, 0xcc, 0x8c,
    0xc8, 0xcc, 0xcc, 0xc8,
    0xc8, 0xcc, 0xcc, 0xcc,
    0xcc, 0x88, 0x88, 0x88,
    0xcc, 0x88, 0x88, 0x8c,
    0xcc, 0x88, 0x88, 0xc8,
    0xcc, 0x88, 0x88, 0xcc,
    0xcc, 0x88, 0x8c, 0x88,
    0xcc, 0x88, 0x8c, 0x8c,
    0xcc, 0x88, 0x8c, 0xc8,
    0xcc, 0x88, 0x8c, 0xcc,
    0xcc, 0x88, 0xc8, 0x88,
    0xcc, 0x88, 0xc8, 0x8c,
    0xcc, 0x88, 0xc8, 0xc8,
    0xcc, 0x88, 0xc8, 0xcc,
    0xcc, 0x88, 0xcc, 0x88,
    0xcc, 0x88, 0xcc, 0x8c,
    0xcc, 0x88, 0xcc, 0xc8,
    0xcc, 0x88, 0xcc, 0xcc,
    0xcc, 0x8c, 0x88, 0x88,
    0xcc, 0x8c, 0x88, 0x8c,
    0xcc, 0x8c, 0x88, 0xc8,
    0xcc, 0x8c, 0x88, 0xcc,
    0xcc, 0x8c, 0x8c, 0x88,
    0xcc, 0x8c, 0x8c, 0x8c,
    0xcc, 0x8c, 0x8c, 0xc8,
    0xcc, 0x8c, 0x8c, 0xcc,
    0xcc, 0x8c, 0xc8, 0x88,
    0xcc, 0x8c, 0xc8, 0x8c,
    0xcc, 0x8c, 0xc8, 0xc8,
    0xcc, 0x8c, 0xc8, 0xcc,
    0xcc, 0x8c, 0xcc, 0x88,
    0xcc, 0x8c, 0xcc, 0x8c,
    0xcc, 0x8c, 0xcc, 0xc8,
    0xcc, 0x8c, 0xcc, 0xcc,
    0xcc, 0xc8, 0x88, 0x88,
    0xcc, 0xc8, 0x88, 0x8c,
    0xcc, 0xc8, 0x88, 0xc8,
    0xcc, 0xc8, 0x88, 0xcc,
    0xcc, 0xc8, 0x8c, 0x88,
    0xcc, 0xc8, 0x8c, 0x8c,
    0xcc, 0xc8, 0x8c, 0xc8,
    0xcc, 0xc8, 0x8c, 0xcc,
    0xcc, 0xc8, 0xc8, 0x88,
    0xcc, 0xc8, 0xc8, 0x8c,
    0xcc, 0xc8, 0xc8, 0xc8,
    0xcc, 0xc8, 0xc8, 0xcc,
    0xcc, 0xc8, 0xcc, 0x88,
    0xcc, 0xc8, 0xcc, 0x8c,
    0xcc, 0xc8, 0xcc, 0xc8,
    0xcc, 0xc8, 0xcc, 0xcc,
    0xcc, 0xcc, 0x88, 0x88,
    0xcc, 0xcc, 0x88, 0x8c,
    0xcc, 0xcc, 0x88, 0xc8,
    0xcc, 0xcc, 0x88, 0xcc,
    0xcc, 0xcc, 0x8c, 0x88,
    0xcc, 0xcc, 0x8c, 0x8c,
    0xcc, 0xcc, 0x8c, 0xc8,
    0xcc, 0xcc, 0x8c, 0xcc,
    0xcc, 0xcc, 0xc8, 0x88,
    0xcc, 0xcc, 0xc8, 0x8c,
    0xcc, 0xcc, 0xc8, 0xc8,
    0xcc, 0xcc, 0xc8, 0xcc,
    0xcc, 0xcc, 0xcc, 0x88,
    0xcc, 0xcc, 0xcc, 0x8c,
    0xcc, 0xcc, 0xcc, 0xc8,
    0xcc, 0xcc, 0xcc, 0xcc
};

static uint8_t led_buffer[LED_BUFFER_SIZE] = {LED_00};

void led_init(void)
{
    rcc_periph_clock_enable(RCC_GPIOB);
    gpio_mode_setup(GPIOB, GPIO_MODE_AF, GPIO_PUPD_NONE, GPIO7);
    gpio_set_output_options(GPIOB, GPIO_OTYPE_PP, GPIO_OSPEED_50MHZ, GPIO7);
    gpio_set_af(GPIOB, GPIO_AF1, GPIO7);

    rcc_periph_clock_enable(RCC_SPI2);
    spi_reset(SPI2);
    spi_init_master(SPI2, SPI_CR1_BAUDRATE_FPCLK_DIV_16, SPI_CR1_CPOL_CLK_TO_0_WHEN_IDLE, SPI_CR1_CPHA_CLK_TRANSITION_1, SPI_CR1_MSBFIRST);
    spi_enable(SPI2);

    led_clear();
    led_flush();
}

void led_flush(void)
{
    for (uint32_t i = 0; i < LED_BUFFER_SIZE; i++)
    {
        spi_send8(SPI2, led_buffer[i]);
    }
    for (uint32_t i = 0; i < LED_RESET_SIZE; i++)
    {
        spi_send8(SPI2, 0x00);
    }
}

void led_clear(void)
{
    memset(led_buffer, LED_00, LED_BUFFER_SIZE);
}

void led_set(uint32_t led, led_colour_t c)
{
    uint32_t base_addr;
    if (led < LED_COUNT)
    {
        base_addr = led * LED_BYTES;
        memcpy(&led_buffer[base_addr],   &COLOUR_MAP[c.g], 4); // green
        memcpy(&led_buffer[base_addr+4], &COLOUR_MAP[c.r], 4); // green
        memcpy(&led_buffer[base_addr+8], &COLOUR_MAP[c.b], 4); // green
    }
}

void led_set_all(led_colour_t c)
{
    for (uint32_t led = 0; led < LED_COUNT; led++)
    {
        led_set(led, c);
    }
}

void led_set_pixel(int x, int y, led_colour_t c)
{
    if ((x >= 0) && (x < LED_COLS) && (y >= 0) && (y < LED_ROWS) && (LED_ADDRESSES[y][x] < LED_COUNT))
    {
        led_set(LED_ADDRESSES[y][x], c);
    }
}