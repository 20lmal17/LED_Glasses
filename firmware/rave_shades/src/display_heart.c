#include <math.h>

#include "display_heart.h"
#include "led.h"
#include "goertzel.h"
#include "util.h"

#define ANIMATION_HEART_LEN (8U)
#define FREQUENCY_BIN_COUNT 1

extern const colour_t heart[ANIMATION_HEART_LEN][LED_COUNT];
const uint32_t frequency_bins[FREQUENCY_BIN_COUNT] = {2/*54Hz*/};

goertzel_cache_t goertzel_coef[FREQUENCY_BIN_COUNT];


void display_heart_init(void)
{
    goertzel_init(frequency_bins, FREQUENCY_BIN_COUNT, AUDIO_BUF_FILT_LEN, goertzel_coef);
}

void display_heart_run(context_t *context)
{
    static uint32_t count;
    static float mean;
    static float variance;

    count = 0;
    mean = 0;
    variance = 0;

    if (context->audio_updated > 0)
    {
        context->audio_updated = 0;
        led_clear();

        fixed_t a, b;
        float c, d;
        float bass = 0;
        for (uint32_t i = 0; i < FREQUENCY_BIN_COUNT; i++)
        {
            goertzel_transform(context->audio_filtered, AUDIO_BUF_FILT_LEN, goertzel_coef[i], &a, &b);
            c = fixed_to_float(a);
            d = fixed_to_float(b);
            bass += log2f(c * c + d * d);
        }
        bass /= FREQUENCY_BIN_COUNT;

        
    }
}

const colour_t heart[ANIMATION_HEART_LEN][LED_COUNT] = {{ // frame 1
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}
    }, { // frame 2
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}
    }, { // frame 3
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0},
        {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}
    }, { // frame 4
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0},
        {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}
    }, { // frame 5
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}
    }, { // frame 6
        {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  0,   0,   0}, {  0,   0,   0}
    }, { // frame 7
        {  0,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  0,   0,   0},
        {  4,   0,   0}, {  0,   0,   0}
    }, { // frame 8
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  0,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0}, {  4,   0,   0},
        {  4,   0,   0}, {  4,   0,   0}
}};